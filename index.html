<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stra√üenwacht: Connected</title>
    <!-- PWA Integration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.svg">

    <style>
        :root {
            --bg-color: #0f172a; /* Deep Space Blue */
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            /* Neues Gelb Schema (#ffcd00 Basis) */
            --accent-color: #ffcd00; 
            --accent-dark: #e6b800; /* Etwas dunkler f√ºr Kontraste */
            --accent-glow: rgba(255, 205, 0, 0.5);
            
            --danger-color: #ef4444;
            --success-color: #10b981;
            --tech-blue: #3b82f6; /* F√ºr den Connected Car Modus */
            --shield-color: #06b6d4; /* Cyan f√ºr das Schild */
            --magnet-color: #d946ef; /* Magenta f√ºr den Magnet */
            
            /* Charakter Farben */
            --skin-color: #ffdbac; 
            --hair-color: #262626; 
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            /* Prevent touch highlighting on mobile */
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* Fix for mobile scrolling issues */
            height: 100dvh; 
            color: var(--text-primary);
            padding: 20px;
            /* Retro Grid Hintergrund */
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            overflow: hidden; /* Prevent body scroll */
        }

        .game-card {
            background: var(--card-bg);
            width: 100%;
            max-width: 900px;
            /* Auf Desktop fixe H√∂he f√ºr Konsistenz, auf Mobile flexibel */
            height: 85vh; 
            max-height: 900px;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Spiel Bereich: Flex Grow f√ºllt den Rest */
        .game-container {
            width: 100%;
            flex-grow: 1; /* DAS IST DER FIX: Nimmt allen verf√ºgbaren Platz */
            background-color: #334155;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            min-height: 0; /* Wichtig f√ºr Flexbox Nesting */
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* --- UI OVERLAYS (Retro Style) --- */
        .overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 20;
            padding: 20px;
            transition: opacity 0.3s;
            overflow-y: auto; /* Allow scrolling inside overlay on very small screens */
        }
        
        /* Scanline Effekt */
        .overlay::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: -1;
        }

        /* Animierter Titel */
        @keyframes glowPulse {
            0%, 100% { text-shadow: 0 0 20px var(--accent-glow); transform: scale(1); }
            50% { text-shadow: 0 0 40px var(--accent-glow); transform: scale(1.02); }
        }

        .game-title {
            font-size: 3rem; /* Etwas kleiner f√ºr Sicherheit */
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: -2px;
            margin-bottom: 0;
            text-align: center;
            line-height: 1;
            /* Gradient Text */
            background: linear-gradient(to bottom right, #ffcd00, #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(255, 205, 0, 0.3));
            animation: glowPulse 3s infinite ease-in-out;
        }

        .game-subtitle {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1rem;
            color: #94a3b8;
            margin-top: 5px;
            margin-bottom: 20px;
            text-transform: lowercase;
            letter-spacing: 2px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 5px;
        }

        /* STORY SCREEN STYLES */
        .story-content {
            max-width: 600px;
            text-align: left;
            font-family: 'Courier New', monospace;
            color: #cbd5e1;
            line-height: 1.5;
            margin-bottom: 30px;
            position: relative;
            font-size: 0.95rem;
        }
        .story-line {
            margin-bottom: 12px;
            opacity: 0;
            animation: fadeIn 0.8s forwards;
        }
        .story-line:nth-child(1) { animation-delay: 0.5s; }
        .story-line:nth-child(2) { animation-delay: 1.5s; }
        .story-line:nth-child(3) { animation-delay: 3.0s; }
        .story-line:nth-child(4) { animation-delay: 4.5s; }
        .story-line:nth-child(5) { animation-delay: 6.5s; }
        .story-line:nth-child(6) { animation-delay: 8.0s; }
        .story-line:nth-child(7) { animation-delay: 9.5s; }
        .story-line:nth-child(8) { animation-delay: 11.5s; }
        
        @keyframes fadeIn { to { opacity: 1; } }

        /* CSS CHARACTER (Pannenfahrer SVG) */
        .driver-container {
            width: 180px;
            height: 200px;
            position: relative;
            margin-bottom: 20px;
            flex-shrink: 0; /* Verhindert das Quetschen auf kleinen screens */
        }
        
        .driver-svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.4));
        }

        /* Namensschild Animation */
        .name-tag {
            background: #ffffff;
            color: #0f172a;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            position: absolute;
            top: 140px; 
            right: 40px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: scale(0);
            max-width: 70px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: 1px solid #cbd5e1;
            z-index: 10;
        }
        
        .name-tag.visible {
            transform: scale(1) rotate(-3deg);
        }

        /* Leaderboard Panel */
        .leaderboard-panel {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            width: 100%;
            max-width: 350px;
            margin-bottom: 20px;
            /* Auf kleinen Screens weniger Platz einnehmen */
            flex-shrink: 1;
            min-height: 100px;
            display: flex;
            flex-direction: column;
        }

        .leaderboard-header {
            text-transform: uppercase;
            font-size: 0.7rem;
            font-weight: bold;
            letter-spacing: 1.5px;
            color: #64748b;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 5px;
        }

        .leaderboard-list {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #475569 transparent;
            flex-grow: 1; /* F√ºllt den Rest des Panels */
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            border-radius: 4px;
        }
        .leaderboard-item:nth-child(odd) { background: rgba(255,255,255,0.03); }
        .rank { color: var(--accent-color); font-weight: bold; width: 30px; }
        .name { flex-grow: 1; color: #cbd5e1; }
        .score { color: var(--success-color); font-weight: bold; }

        /* STATISTICS GRID (Game Over) */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
            max-width: 350px;
            margin-bottom: 20px;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--text-primary);
        }
        .stat-label {
            font-size: 0.7rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* DIAGNOSTIC OVERLAY (Connected Car) */
        .diag-container {
            width: 95%; /* Responsive Width */
            max-width: 500px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--tech-blue);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
            display: none; 
        }
        
        /* Boot Sequence Styles */
        .boot-container {
            width: 95%;
            max-width: 600px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            color: var(--tech-blue);
            font-size: 1rem;
            text-align: left;
            text-shadow: 0 0 5px var(--tech-blue);
        }
        .terminal-cursor {
            display: inline-block;
            width: 10px;
            height: 18px;
            background-color: var(--tech-blue);
            animation: blink 1s step-end infinite;
            vertical-align: text-bottom;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .diag-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--tech-blue);
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: var(--tech-blue);
            font-family: monospace;
            font-size: 0.8rem;
        }
        .diag-blink { animation: blink 1s infinite; }
        
        .diag-question {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 15px;
            line-height: 1.4;
            color: #fff;
        }
        
        .diag-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .diag-option {
            padding: 10px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid #475569;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: monospace;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            /* Prevent text selection */
            user-select: none;
        }
        
        .diag-option.selected {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--tech-blue);
            color: white;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
        }
        
        .diag-option-key {
            background: #1e293b;
            color: var(--tech-blue);
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .diag-confirm-btn {
            margin-top: 20px;
            width: 100%;
            padding: 12px;
            background: var(--tech-blue);
            color: #0f172a;
            font-weight: bold;
            font-family: monospace;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 1rem;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
            transition: all 0.2s;
        }
        .diag-confirm-btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* Start Button / Prompt */
        .start-btn {
            background: var(--accent-color);
            color: #0f172a;
            font-size: 1.1rem;
            font-weight: 800;
            padding: 12px 32px;
            border-radius: 99px;
            border: none;
            cursor: pointer;
            box-shadow: 0 0 20px var(--accent-glow);
            transition: transform 0.2s, box-shadow 0.2s;
            text-transform: uppercase;
            animation: bounce 2s infinite;
            margin-top: 10px;
        }
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 40px var(--accent-glow);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-5px);}
            60% {transform: translateY(-3px);}
        }

        /* Footer */
        .card-footer {
            padding: 15px 25px;
            background-color: #0f172a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(255,255,255,0.05);
            font-size: 0.75rem;
            color: #475569;
            flex-shrink: 0; /* Footer darf nicht schrumpfen */
        }

        /* Input Styles */
        .highscore-input {
            background: rgba(0,0,0,0.5);
            border: 1px solid #475569;
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            text-align: center;
            width: 100%;
            max-width: 250px;
            margin-bottom: 15px;
        }
        .highscore-input:focus { outline: 2px solid var(--accent-color); border-color: transparent; }

        /* HUD */
        #scoreBoard {
            position: absolute;
            top: 20px; right: 20px;
            font-family: 'Courier New', monospace;
            font-weight: 900;
            font-size: 24px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
            z-index: 5;
        }
        
        #comboText {
            position: absolute;
            top: 50px; right: 20px;
            font-family: 'Courier New', monospace;
            font-weight: 700;
            font-size: 16px;
            color: var(--accent-color);
            text-shadow: 1px 1px 0 #000;
            pointer-events: none;
            z-index: 5;
            display: none;
        }

        #powerupDisplay {
            position: absolute;
            top: 60px; left: 24px; 
            font-family: 'Courier New', monospace;
            font-weight: 700;
            font-size: 18px;
            text-shadow: 1px 1px 0 #000;
            pointer-events: none;
            z-index: 5;
            display: none; /* Hidden by default */
            align-items: center;
            gap: 8px;
        }

        #repairBarContainer {
            position: absolute; width: 60px; height: 8px;
            background: #0f172a; border: 1px solid #94a3b8;
            border-radius: 4px; display: none; pointer-events: none; z-index: 5;
        }
        #repairBarFill {
            width: 0%; height: 100%; background: var(--success-color);
            border-radius: 2px; transition: width 0.1s linear;
        }

        /* UPDATE NOTIFICATION */
        #updateBanner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #0f172a;
            border: 2px solid var(--accent-color);
            border-radius: 12px;
            padding: 15px 25px;
            box-shadow: 0 0 20px rgba(255, 205, 0, 0.3);
            z-index: 100;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 10px;
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        
        .update-text {
            color: #fff;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1rem;
        }
        .update-btn {
            background: var(--accent-color);
            color: #0f172a;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
        }

        /* ADMIN PANEL STYLES */
        .admin-panel {
            background: #0f172a;
            border: 2px solid var(--danger-color);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .admin-title {
            color: var(--danger-color);
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.2rem;
            text-transform: uppercase;
            text-align: center;
            border-bottom: 1px solid var(--danger-color);
            padding-bottom: 10px;
        }
        .admin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: monospace;
        }
        .delete-btn {
            background: transparent;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            border-radius: 4px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .delete-btn:hover {
            background: var(--danger-color);
            color: white;
        }
        .admin-footer-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        /* --- MOBILE OPTIMIZATION (< 768px) --- */
        @media (max-width: 768px) {
            body {
                padding: 0; /* Remove body padding */
                background-image: none; /* Perf optimization */
                background-color: #0f172a;
            }
            .game-card {
                height: 100dvh; /* Full dynamic viewport height */
                max-height: none;
                width: 100%;
                border-radius: 0;
                border: none;
                box-shadow: none;
            }
            .game-container {
                /* Container takes all remaining space */
                flex-grow: 1; 
                height: auto; 
                width: 100%;
            }
            .card-footer {
                padding: 10px 15px; /* Compact footer */
            }
            .game-title {
                font-size: 2.2rem;
            }
            .game-subtitle {
                font-size: 1rem;
                margin-bottom: 15px;
            }
            .driver-container {
                width: 140px; /* Smaller avatar */
                height: 155px;
            }
            .name-tag {
                top: 110px; right: 30px; font-size: 0.6rem;
            }
            .leaderboard-panel {
                padding: 10px;
                max-width: 90%;
            }
            /* Make overlays scrollable just in case content is too tall */
            .overlay {
                justify-content: flex-start; /* Start from top on mobile */
                padding-top: 40px;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>

    <div class="game-card">
        <div class="game-container" id="gameWrapper">
            <canvas id="gameCanvas"></canvas>
            
            <div id="scoreBoard">0</div>
            <div id="comboText">COMBO x2</div>
            
            <!-- Powerup UI -->
            <div id="powerupDisplay">
                <span id="powerupIcon" style="font-size: 1.5rem;">üõ°Ô∏è</span>
                <span id="powerupTimer">30s</span>
            </div>
            
            <div id="repairBarContainer">
                <div id="repairBarFill"></div>
            </div>

            <!-- NAME ENTRY SCREEN (Onboarding) -->
            <div id="nameEntryScreen" class="overlay" style="display: none;">
                <h1 class="game-title" style="margin-bottom: 15px;">Willkommen<br>im Team</h1>
                <p style="margin-bottom: 20px; text-align: center;">Wie ist dein Name, Pannenfahry?</p>
                
                <!-- SVG Character -->
                <div class="driver-container">
                    <svg class="driver-svg" viewBox="0 0 200 220" xmlns="http://www.w3.org/2000/svg">
                        <path d="M50 220 L50 160 Q50 120 100 120 Q150 120 150 160 L150 220 Z" fill="#ffcd00" />
                        <path d="M80 120 L80 140 Q100 150 120 140 L120 120" fill="#1e293b" />
                        <rect x="85" y="100" width="30" height="30" fill="#ffdbac" />
                        <rect x="65" y="40" width="70" height="90" rx="25" fill="#ffdbac" />
                        <circle cx="60" cy="85" r="8" fill="#ffdbac" />
                        <circle cx="140" cy="85" r="8" fill="#ffdbac" />
                        <path d="M55 60 Q60 20 100 20 Q140 20 145 60 L145 70 Q145 50 135 50 L65 50 Q55 50 55 70 Z" fill="#262626" />
                        <path d="M55 60 L65 60 L65 90 L55 80 Z" fill="#262626" />
                        <path d="M145 60 L135 60 L135 90 L145 80 Z" fill="#262626" />
                        <circle cx="82" cy="80" r="5" fill="#1e293b" />
                        <circle cx="118" cy="80" r="5" fill="#1e293b" />
                        <path d="M75 72 Q82 70 89 72" fill="none" stroke="#262626" stroke-width="3" stroke-linecap="round"/>
                        <path d="M111 72 Q118 70 125 72" fill="none" stroke="#262626" stroke-width="3" stroke-linecap="round"/>
                        <path d="M95 85 L95 95 L105 95" fill="none" stroke="#dca685" stroke-width="2" stroke-linecap="round"/>
                        <path d="M90 105 Q100 110 110 105" fill="none" stroke="#1e293b" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <div id="driverBadge" class="name-tag"></div>
                </div>

                <input type="text" id="initialNameInput" class="highscore-input" placeholder="Name eingeben" maxlength="12" oninput="updateNameBadge()">
                <button class="start-btn" onclick="saveNameAndStart()">Weiter</button>
            </div>

            <!-- STORY SCREEN (Briefing) -->
            <div id="storyScreen" class="overlay" style="display: none;">
                <h1 class="game-title" style="font-size: 2rem; margin-bottom: 20px; animation: none; text-shadow: none; color: var(--accent-color);">BRIEFING</h1>
                
                <div class="story-content">
                    <div class="story-line">> Zugriff auf Personalakte... OK.</div>
                    <div class="story-line" style="margin-bottom: 20px;">> Status: Einsatzbereit.</div>
                    
                    <div class="story-line">Bisher mussten wir immer pers√∂nlich raus.</div>
                    <div class="story-line">Hingehen. Anfassen. Reparieren.</div>
                    
                    <div class="story-line" style="margin-top: 20px;">Aber die Stra√üe hat sich ver√§ndert.</div>
                    <div class="story-line">Autos senden jetzt Daten. Fehlercodes.</div>
                    <div class="story-line">Wir empfangen direkt aus dem Motorraum.</div>
                    
                    <div class="story-line" style="margin-top: 20px; color: var(--accent-color); font-weight: bold;">
                        DEINE MISSION STARTET JETZT.
                    </div>
                </div>

                <button class="start-btn" onclick="finishStory()">Verstanden</button>
            </div>

            <!-- ADMIN OVERLAY -->
            <div id="adminOverlay" class="overlay" style="display:none; z-index: 50;">
                <div class="admin-panel">
                    <div class="admin-title">/// ADMIN KONSOLE ///</div>
                    
                    <div id="adminLoginView">
                        <input type="password" id="adminPassInput" class="highscore-input" placeholder="ACCESS CODE" style="border-color: var(--danger-color); width: 100%;">
                        <button class="admin-footer-btn" style="width: 100%;" onclick="adminLogin()">ZUGRIFF ANFORDERN</button>
                    </div>

                    <div id="adminDataView" style="display:none; flex-direction: column; gap: 10px; height: 100%;">
                        <div class="leaderboard-list" id="adminList" style="flex-grow: 1; min-height: 200px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px;">
                            <!-- List populated by JS -->
                        </div>
                        <button class="admin-footer-btn" onclick="forceReload()" style="background: #eab308; color: #000;">‚ôª FORCE RELOAD (PWA)</button>
                        <button class="admin-footer-btn" onclick="adminResetAll()" style="background: #7f1d1d;">‚ö† ALLES L√ñSCHEN</button>
                        <button class="admin-footer-btn" onclick="closeAdmin()" style="background: #334155;">SCHLIESSEN</button>
                    </div>
                    
                    <div id="adminCloseBtn" style="text-align: center; margin-top: 10px; cursor: pointer; color: #64748b; font-size: 0.8rem; text-decoration: underline;" onclick="closeAdmin()">Abbruch</div>
                </div>
            </div>
            
            <!-- UPDATE BANNER -->
            <div id="updateBanner">
                <div class="update-text">SYSTEM UPDATE VERF√úGBAR</div>
                <button class="update-btn" onclick="applyUpdate()">INSTALLIEREN</button>
            </div>

            <!-- START SCREEN -->
            <div id="startScreen" class="overlay" style="display: none;">
                <h1 class="game-title">Stra√üenwacht<br>Connected</h1>
                <div class="game-subtitle">Digital liegenbleiben.</div>
                
                <p id="welcomeText" style="color: var(--accent-color); font-weight: bold; margin-bottom: 10px;">Hallo, Pannenfahry!</p>

                <div class="leaderboard-panel">
                    <div class="leaderboard-header">/// TOP EINSATZKR√ÑFTE ///</div>
                    <div class="leaderboard-list" id="startLeaderboard">
                        <div style="text-align:center; color:#64748b; padding:10px;">Verbinde mit Zentrale...</div>
                    </div>
                </div>

                <button class="start-btn" onclick="startGame()">Start Engine</button>
                
                <div style="margin-top: 20px; font-size: 0.8rem; color: #64748b;">
                    Steuerung: Pfeiltasten oder A / D
                </div>
                <div style="margin-top: 10px; font-size: 0.75rem; color: #ef4444; cursor: pointer; text-decoration: underline;" onclick="logout()">
                    Abmelden / Anderer Fahrer
                </div>
            </div>

            <!-- DIAGNOSTIC OVERLAY (New) -->
            <div id="diagnosticOverlay" class="overlay" style="display: none; background: rgba(0,0,0,0.95); z-index: 30;">
                
                <!-- Boot Sequence Container -->
                <div id="bootSequence" class="boot-container" style="display: block;">
                    <div id="bootText"></div><span class="terminal-cursor"></span>
                </div>

                <!-- Main Diagnostic UI -->
                <div id="diagContainer" class="diag-container">
                    <div class="diag-header">
                        <span>> CONNECTED CAR INTERFACE</span>
                        <span class="diag-blink">‚óè LIVE</span>
                    </div>
                    
                    <div class="diag-question" id="diagQuestionText">
                        Fehleranalyse l√§uft...
                    </div>
                    
                    <div class="diag-options" id="diagOptionsList">
                        <!-- Options generated by JS -->
                    </div>
                    
                    <button class="diag-confirm-btn" onclick="resolveDiagnostic()">DIAGNOSE SENDEN [ENTER]</button>
                </div>
            </div>

            <!-- GAME OVER SCREEN -->
            <div id="gameOverScreen" class="overlay" style="display: none;">
                <h2 id="gameOverTitle" style="color: var(--danger-color); font-size: 2.5rem; text-transform: uppercase; margin-bottom: 10px;">Unfall!</h2>
                <p style="font-size: 1.1rem; color: #94a3b8; margin-bottom: 20px;">Score: <span id="finalScore" style="color: white; font-weight: bold;">0</span></p>
                
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="statRepairs">0</span>
                        <span class="stat-label">Pannen</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="statMissed" style="color: #ef4444;">0</span>
                        <span class="stat-label">Verpasst</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="statDodged" style="color: #3b82f6;">0</span>
                        <span class="stat-label">Verkehr</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="statAMDs" style="color: #10b981;">0</span>
                        <span class="stat-label">AMDs</span>
                    </div>
                </div>

                <div id="submittingScoreText" style="color: var(--accent-color); font-family: monospace; margin-bottom: 15px; display: none;">
                    > Sende Daten an Zentrale...
                </div>

                <div id="gameOverLeaderboard" class="leaderboard-panel" style="display: none;">
                    <div class="leaderboard-header">/// RANGLISTE AKTUALISIERT ///</div>
                    <div class="leaderboard-list" id="gameOverLeaderboardList"></div>
                </div>

                <div style="margin-top: 30px;">
                    <p style="color: #64748b; cursor: pointer; text-decoration: underline;" onclick="resetGame()">Leertaste f√ºr Neustart</p>
                </div>
            </div>
        </div>

        <div class="card-footer">
            <div style="font-weight: 600;">
                built with ‚ù§Ô∏è by marcus
            </div>
            <div style="opacity: 0.5; font-family: monospace;">
                ADAC_DEV_BUILD_2026 <span onclick="toggleAdmin()" style="cursor: pointer; margin-left: 8px;" title="Admin Access">[‚ö°]</span>
            </div>
        </div>
    </div>

    <!-- SERVICE WORKER REGISTRATION (PWA) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => {
                    console.log('SW registered');
                    // Check for updates
                    reg.onupdatefound = () => {
                        const newWorker = reg.installing;
                        newWorker.onstatechange = () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available
                                document.getElementById('updateBanner').style.display = 'flex';
                            }
                        };
                    };
                }).catch(err => console.log('SW failed', err));
            });
        }
        
        function applyUpdate() {
            // Unregister and reload to force update
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
                window.location.reload();
            });
        }
    </script>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('gameWrapper');
        
        // Screens
        const nameEntryScreen = document.getElementById('nameEntryScreen');
        const storyScreen = document.getElementById('storyScreen'); // New
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const diagnosticOverlay = document.getElementById('diagnosticOverlay');
        const adminOverlay = document.getElementById('adminOverlay');
        
        // UI Elements
        const scoreBoard = document.getElementById('scoreBoard');
        const comboText = document.getElementById('comboText');
        const finalScoreDisplay = document.getElementById('finalScore');
        const repairBar = document.getElementById('repairBarContainer');
        const repairFill = document.getElementById('repairBarFill');
        const startLeaderboard = document.getElementById('startLeaderboard');
        const initialNameInput = document.getElementById('initialNameInput');
        const driverBadge = document.getElementById('driverBadge');
        const welcomeText = document.getElementById('welcomeText');
        const gameOverLeaderboard = document.getElementById('gameOverLeaderboard');
        const gameOverLeaderboardList = document.getElementById('gameOverLeaderboardList');
        const submittingScoreText = document.getElementById('submittingScoreText');
        const powerupDisplay = document.getElementById('powerupDisplay');
        const powerupIcon = document.getElementById('powerupIcon');
        const powerupTimer = document.getElementById('powerupTimer');
        
        // Admin Elements
        const adminPassInput = document.getElementById('adminPassInput');
        const adminLoginView = document.getElementById('adminLoginView');
        const adminDataView = document.getElementById('adminDataView');
        const adminList = document.getElementById('adminList');
        const adminCloseBtn = document.getElementById('adminCloseBtn');
        
        // Diagnostic Elements
        const diagContainer = document.getElementById('diagContainer');
        const bootSequenceDiv = document.getElementById('bootSequence');
        const bootTextDiv = document.getElementById('bootText');
        const diagQuestionText = document.getElementById('diagQuestionText');
        const diagOptionsList = document.getElementById('diagOptionsList');

        // Game State
        let gameState = 'INIT'; 
        let score = 0;
        let roadOffset = 0;
        let baseSpeed = 5; 
        let gameSpeed = baseSpeed;
        
        let currentLeaderboard = [];
        let repairsCount = 0;
        let missedRepairs = 0;
        let dodgedCars = 0;
        let solvedAMDs = 0;

        let currentPlayerName = null;
        let combo = 0;
        
        // Diagnostic Logic
        let currentDiagQuestion = null;
        let diagSelectedIndex = 0;
        
        // Powerup Logic
        let shieldActive = false;
        let magnetActive = false;
        let powerupEndTime = 0;
        let nextPowerupType = 'shield'; // toggles between 'shield' and 'magnet'

        // Fragen Katalog (Connected Car Challenge)
        const diagnosticQuestions = [
            { scenario: "Motor startet nicht, Licht & Radio funktionieren nicht. Kein Anlasser-Ger√§usch.", options: ["Lichtmaschine defekt", "Batterie tiefentladen", "Z√ºndkerzen verschlissen", "Tank leer"], correct: 1 },
            { scenario: "Motor √ºberhitzt, wei√üer Rauch steigt aus der Motorhaube auf.", options: ["K√ºhlmittelverlust", "Zu wenig √ñl", "Reifenpanne", "Klimaanlage defekt"], correct: 0 },
            { scenario: "Warnleuchte '√ñlkanne' leuchtet rot auf.", options: ["Wischwasser leer", "Zu viel √ñl", "√ñldruck zu niedrig", "Bremsbel√§ge abgenutzt"], correct: 2 },
            { scenario: "Fahrzeug zieht beim Bremsen stark nach links.", options: ["Radio zu laut", "Bremssattel fest", "Batterie schwach", "Auspuff undicht"], correct: 1 },
            { scenario: "Blaue Wolke kommt beim Gasgeben aus dem Auspuff.", options: ["Motor verbrennt √ñl", "Wasser im Tank", "Katalysator neu", "Reifen drehen durch"], correct: 0 },
            { scenario: "Lautes Klackern vorne beim Einlenken und Anfahren.", options: ["Hupe defekt", "Antriebswelle defekt", "Fenster offen", "Scheibenwischer trocken"], correct: 1 },
            { scenario: "Motor l√§uft unrund, Motorkontrollleuchte blinkt gelb.", options: ["Z√ºndaussetzer", "Reifen platt", "Kofferraum offen", "Tank voll"], correct: 0 },
            { scenario: "Reifen sind an den Au√üenkanten stark abgefahren.", options: ["Zu hoher Luftdruck", "Falsche Spur/Sturz", "Zu wenig Profil", "Felge rostig"], correct: 1 },
            { scenario: "Motor geht w√§hrend der Fahrt einfach aus und springt nicht mehr an.", options: ["Lichtmaschine/Generator", "K√ºhlwasser leer", "Bremslicht defekt", "Radio Sicherung"], correct: 0 },
            { scenario: "Schwarzer Rauch aus dem Auspuff bei Diesel-Fahrzeug.", options: ["Luftfilter verstopft/Turbo", "AdBlue leer", "Falsch getankt (Benzin)", "Z√ºndkerzen nass"], correct: 0 },
            { scenario: "Kupplungspedal bleibt am Boden liegen.", options: ["Seilzug/Hydraulik defekt", "Gaspedal klemmt", "Bremsfl√ºssigkeit voll", "Batterie leer"], correct: 0 },
            { scenario: "Fahrzeug vibriert stark ab 100 km/h im Lenkrad.", options: ["Unwucht in R√§dern", "Motorlager defekt", "Keilriemen lose", "Auspuff lose"], correct: 0 },
            { scenario: "S√º√ülicher Geruch im Innenraum, Scheiben beschlagen.", options: ["W√§rmetauscher undicht", "Klimaanlage leer", "Duftbaum verfallen", "Fenster offen"], correct: 0 },
            { scenario: "Auto springt morgens schlecht an, 'Vorgl√ºh'-Lampe blinkt.", options: ["Gl√ºhkerzen defekt", "Turbolader defekt", "√ñlwechsel f√§llig", "Reifendruck niedrig"], correct: 0 },
            { scenario: "Gangschaltung l√§sst sich bei laufendem Motor schwer einlegen.", options: ["Kupplung trennt nicht", "Handbremse angezogen", "Lenkradsperre drin", "Licht an"], correct: 0 },
            { scenario: "Metallisches Schleifen beim Bremsen.", options: ["Bremsbel√§ge runter", "Rost an der T√ºr", "Auspuff schleift", "Radlager defekt"], correct: 0 },
            { scenario: "ESP-Leuchte brennt dauerhaft.", options: ["ABS/Drehzahlsensor", "Reifen zu neu", "Motor zu warm", "Radio kein Empfang"], correct: 0 },
            { scenario: "Motor ruckelt stark beim Beschleunigen.", options: ["Kraftstofffilter zu", "Scheibenwasser leer", "Innenraumlicht an", "Reifen unwuchtig"], correct: 0 },
            { scenario: "Schl√ºssel dreht sich nicht im Z√ºndschloss.", options: ["Lenkradschloss eingerastet", "Falscher Schl√ºssel", "Batterie leer", "Anlasser defekt"], correct: 0 },
            { scenario: "Fahrzeugbeleuchtung flackert im Leerlauf.", options: ["Spannungsregler defekt", "Birne locker", "Radio zu laut", "Sicherung durch"], correct: 0 }
        ];
        
        // Repair Logic
        let repairTimer = 0;
        const repairDuration = 50; 
        let currentTarget = null; 

        // Canvas Sizing
        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        /* --- SESSION MANAGEMENT --- */
        
        function initGame() {
            const storedName = localStorage.getItem('pannenfahrerName');
            
            if (storedName) {
                currentPlayerName = storedName;
                welcomeText.textContent = `Hallo, ${currentPlayerName}!`;
                showStartScreen();
            } else {
                showNameEntry();
            }
        }

        function showNameEntry() {
            nameEntryScreen.style.display = 'flex';
            startScreen.style.display = 'none';
            storyScreen.style.display = 'none';
            initialNameInput.focus();
        }

        function showStoryScreen() {
            nameEntryScreen.style.display = 'none';
            storyScreen.style.display = 'flex';
        }

        function finishStory() {
            storyScreen.style.display = 'none';
            showStartScreen();
        }

        function showStartScreen() {
            nameEntryScreen.style.display = 'none';
            storyScreen.style.display = 'none';
            startScreen.style.display = 'flex';
            fetchLeaderboard();
        }

        function updateNameBadge() {
            const val = initialNameInput.value;
            driverBadge.textContent = val;
            if (val.trim().length > 0) {
                driverBadge.classList.add('visible');
            } else {
                driverBadge.classList.remove('visible');
            }
        }

        function saveNameAndStart() {
            const name = initialNameInput.value.trim();
            if (!name) return;
            
            // Normalize name (e.g. capitalize first letter)
            const cleanName = name.charAt(0).toUpperCase() + name.slice(1);
            
            localStorage.setItem('pannenfahrerName', cleanName);
            currentPlayerName = cleanName;
            welcomeText.textContent = `Hallo, ${currentPlayerName}!`;
            
            // Show Story first
            showStoryScreen();
        }

        function logout() {
            localStorage.removeItem('pannenfahrerName');
            currentPlayerName = null;
            initialNameInput.value = '';
            driverBadge.classList.remove('visible');
            initGame();
        }

        /* --- API FUNCTIONS --- */
        
        async function fetchLeaderboard() {
            try {
                const res = await fetch('/api/highscores');
                if (res.ok) {
                    currentLeaderboard = await res.json();
                    renderLeaderboard(currentLeaderboard, startLeaderboard);
                } else { throw new Error('API Offline'); }
            } catch (e) {
                if(currentLeaderboard.length === 0) {
                    renderLeaderboard([
                        { name: "GelberEngel", score: 150 },
                        { name: "PannenPro", score: 120 },
                        { name: "TrafficKing", score: 95 }
                    ], startLeaderboard);
                }
            }
        }

        async function autoSubmitScore() {
            if (!currentPlayerName || score <= 0) {
                // Just show leaderboard if no score or name error
                gameOverLeaderboard.style.display = 'block';
                renderLeaderboard(currentLeaderboard, gameOverLeaderboardList);
                return;
            }

            submittingScoreText.style.display = 'block';

            // Check if player already has a higher score locally (opt.)
            // We trust the backend to handle it, but can check visually
            const existingEntry = currentLeaderboard.find(entry => (entry.name || entry.member) === currentPlayerName);
            if (existingEntry && existingEntry.score >= score) {
                submittingScoreText.textContent = `> Dein Rekord (${existingEntry.score}) bleibt bestehen.`;
                gameOverLeaderboard.style.display = 'block';
                renderLeaderboard(currentLeaderboard, gameOverLeaderboardList);
                return;
            }

            try {
                const res = await fetch('/api/submit-score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: currentPlayerName, score: score })
                });
                
                if (res.ok) {
                    submittingScoreText.textContent = "> DATEN √úBERTRAGEN. HIGHSCORE!";
                    submittingScoreText.style.color = "var(--success-color)";
                    
                    const newData = await (await fetch('/api/highscores')).json();
                    currentLeaderboard = newData;
                    
                    gameOverLeaderboard.style.display = 'block';
                    renderLeaderboard(newData, gameOverLeaderboardList);
                } else {
                    submittingScoreText.textContent = "> FEHLER BEI DER √úBERTRAGUNG.";
                }
            } catch (e) {
                console.error(e);
                submittingScoreText.textContent = "> OFFLINE MODUS.";
                gameOverLeaderboard.style.display = 'block';
                renderLeaderboard(currentLeaderboard, gameOverLeaderboardList);
            }
        }

        function renderLeaderboard(data, target) {
            if (!data || data.length === 0) {
                target.innerHTML = '<div style="text-align:center; padding:10px; color:#64748b">Keine Daten</div>';
                return;
            }
            let html = '';
            data.forEach((entry, index) => {
                html += `
                    <div class="leaderboard-item">
                        <span class="rank">#${index + 1}</span>
                        <span class="name">${entry.name || entry.member}</span>
                        <span class="score">${entry.score}</span>
                    </div>
                `;
            });
            target.innerHTML = html;
        }

        /* --- ADMIN LOGIC --- */
        let adminPassword = "";

        function toggleAdmin() {
            adminOverlay.style.display = 'flex';
            adminLoginView.style.display = 'block';
            adminDataView.style.display = 'none';
            adminPassInput.value = "";
            adminCloseBtn.style.display = "block"; // Allow cancel at login
        }

        function closeAdmin() {
            adminOverlay.style.display = 'none';
        }

        async function adminLogin() {
            const pwd = adminPassInput.value;
            if(!pwd) return;
            adminPassword = pwd;

            try {
                // Fetch data using password for auth
                const res = await fetch('/api/admin/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPassword })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    renderAdminList(data);
                    adminLoginView.style.display = 'none';
                    adminDataView.style.display = 'flex';
                    adminCloseBtn.style.display = "none"; // Hide bottom link, show button inside
                } else {
                    alert("ZUGRIFF VERWEIGERT.");
                }
            } catch (e) {
                console.error(e);
                alert("Verbindungsfehler.");
            }
        }

        function renderAdminList(data) {
            if (!data || data.length === 0) {
                adminList.innerHTML = '<div style="color:#94a3b8; text-align:center;">Keine Eintr√§ge</div>';
                return;
            }
            let html = '';
            data.forEach(entry => {
                const name = entry.name || entry.member;
                html += `
                    <div class="admin-item">
                        <span>${name} (${entry.score})</span>
                        <button class="delete-btn" onclick="adminDelete('${name}')">üóëÔ∏è</button>
                    </div>
                `;
            });
            adminList.innerHTML = html;
        }

        async function adminDelete(member) {
            if(!confirm(`${member} wirklich l√∂schen?`)) return;

            try {
                const res = await fetch('/api/admin/delete-score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPassword, member: member })
                });

                if(res.ok) {
                    // Refresh list
                    const refreshRes = await fetch('/api/admin/data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: adminPassword })
                    });
                    const data = await refreshRes.json();
                    renderAdminList(data);
                    // Also refresh game leaderboard in background
                    fetchLeaderboard();
                } else {
                    alert("L√∂schen fehlgeschlagen.");
                }
            } catch(e) { console.error(e); }
        }

        async function adminResetAll() {
            if(!confirm("WARNUNG: ALLE HIGHSCORES WERDEN UNWIDERRUFLICH GEL√ñSCHT!")) return;
            
            try {
                const res = await fetch('/api/admin/reset-highscores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: adminPassword })
                });

                if(res.ok) {
                    alert("DATENBANK BEREINIGT.");
                    adminList.innerHTML = "";
                    fetchLeaderboard();
                }
            } catch(e) { console.error(e); }
        }
        
        async function forceReload() {
            if (!confirm("PWA Cache leeren und Seite neu laden?")) return;

            // 1. Unregister Service Worker
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    await registration.unregister();
                }
            }

            // 2. Clear Caches
            if ('caches' in window) {
                const keys = await caches.keys();
                for (const key of keys) {
                    await caches.delete(key);
                }
            }

            // 3. Reload
            window.location.reload(true);
        }


        /* --- DIAGNOSTIC MODE LOGIC --- */

        async function triggerDiagnosticMode() {
            gameState = 'BOOTING';
            diagnosticOverlay.style.display = 'flex';
            bootSequenceDiv.style.display = 'block';
            diagContainer.style.display = 'none';
            
            // Boot Animation
            const lines = [
                "> ESTABLISHING SECURE CONNECTION...",
                "> VERBINDUNG HERGESTELLT.",
                "> INITIALISIERE AMD...", 
                "> FEHLERCODES ERKANNT.",
                "> BITTE DIAGNOSTIZIEREN SIE!"
            ];
            
            bootTextDiv.innerHTML = "";
            for (let line of lines) {
                await typeLine(line);
                await new Promise(r => setTimeout(r, 400));
            }
            
            await new Promise(r => setTimeout(r, 800));
            
            // Switch to Diagnostic Interface
            bootSequenceDiv.style.display = 'none';
            diagContainer.style.display = 'block';
            gameState = 'DIAGNOSING';
            
            // Pick Random Question
            currentDiagQuestion = diagnosticQuestions[Math.floor(Math.random() * diagnosticQuestions.length)];
            diagSelectedIndex = 0;
            
            // Render
            diagQuestionText.textContent = currentDiagQuestion.scenario;
            renderDiagOptions();
        }
        
        function typeLine(text) {
            return new Promise(resolve => {
                const p = document.createElement('div');
                bootTextDiv.appendChild(p);
                let i = 0;
                const interval = setInterval(() => {
                    p.textContent += text.charAt(i);
                    i++;
                    if (i >= text.length) {
                        clearInterval(interval);
                        resolve();
                    }
                }, 30); 
            });
        }

        function renderDiagOptions() {
            diagOptionsList.innerHTML = '';
            currentDiagQuestion.options.forEach((opt, idx) => {
                const el = document.createElement('div');
                el.className = `diag-option ${idx === diagSelectedIndex ? 'selected' : ''}`;
                el.innerHTML = `<span class="diag-option-key">${idx + 1}</span> ${opt}`;
                el.onclick = () => { diagSelectedIndex = idx; renderDiagOptions(); };
                diagOptionsList.appendChild(el);
            });
        }

        function resolveDiagnostic() {
            const isCorrect = diagSelectedIndex === currentDiagQuestion.correct;
            
            diagnosticOverlay.style.display = 'none';
            
            if (isCorrect) {
                score += 50;
                solvedAMDs++;
                floatingTexts.push(new FloatingSign(player.x, player.y - 60, "SYSTEM OK! +50", "#10b981"));
                activatePowerup(); 
            } else {
                score -= 50;
                floatingTexts.push(new FloatingSign(player.x, player.y - 60, "SYSTEM FAILURE! -50", "#ef4444")); 
            }
            
            scoreBoard.textContent = score;
            
            // Resume Game
            gameState = 'PLAYING';
            spawnCar();
        }
        
        // --- POWERUP LOGIC ---
        function activatePowerup() {
            powerupEndTime = Date.now() + 30000; // 30 seconds
            
            if (nextPowerupType === 'shield') {
                shieldActive = true;
                magnetActive = false;
                powerupIcon.innerText = "üõ°Ô∏è";
                powerupDisplay.style.color = "var(--shield-color)";
                nextPowerupType = 'magnet'; // Toggle next
                floatingTexts.push(new FloatingSign(player.x, player.y - 90, "Unfallschild!!", "var(--shield-color)"));
            } else {
                magnetActive = true;
                shieldActive = false;
                powerupIcon.innerText = "üß≤";
                powerupDisplay.style.color = "var(--magnet-color)";
                nextPowerupType = 'shield'; // Toggle next
                floatingTexts.push(new FloatingSign(player.x, player.y - 90, "Connectivity Magnet!!", "var(--magnet-color)"));
            }
            
            powerupDisplay.style.display = 'flex';
        }

        /* --- GAME ENGINE --- */
        const player = { x: 0, y: 0, width: 44, height: 75, speed: 8, color: '#ffcd00', type: 'towtruck' };
        let cars = [];
        let particles = []; 
        let floatingTexts = []; 

        // Renamed class to FloatingSign for better clarity
        class FloatingSign {
            constructor(x, y, text, color) {
                this.x = x;
                this.y = y;
                this.text = text;
                this.color = color;
                this.life = 1.0;
                this.vy = -2; // Faster up
                this.rotation = (Math.random() - 0.5) * 0.3; // Random tilt
                this.scale = 0;
            }

            update() {
                this.y += this.vy;
                this.life -= 0.015;
                // Pop in animation
                if (this.scale < 1.2 && this.life > 0.8) {
                     this.scale += 0.2;
                } else if (this.scale > 1.0) {
                     this.scale -= 0.05;
                }
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                ctx.scale(this.scale, this.scale);
                ctx.globalAlpha = Math.max(0, this.life);

                // Determine color value from CSS variable or hex string
                let actualColor = this.color;
                if (this.color.startsWith('var')) {
                    if (this.color.includes('shield')) actualColor = '#06b6d4';
                    else if (this.color.includes('magnet')) actualColor = '#d946ef';
                    else if (this.color.includes('success')) actualColor = '#10b981';
                    else if (this.color.includes('danger')) actualColor = '#ef4444';
                    else actualColor = '#ffffff'; 
                }

                ctx.font = "bold 16px 'Courier New', monospace"; 
                const textWidth = ctx.measureText(this.text).width;
                const padding = 10;
                const boxWidth = textWidth + padding * 2;
                const boxHeight = 34;

                // Shadow (Glow)
                ctx.shadowColor = actualColor;
                ctx.shadowBlur = 15;

                // Background (Dark)
                ctx.fillStyle = '#1e293b'; 
                ctx.strokeStyle = actualColor;
                ctx.lineWidth = 2;
                
                ctx.beginPath();
                // Draw rounded rect manually for compatibility
                const x = -boxWidth/2, y = -boxHeight/2, w = boxWidth, h = boxHeight, r = 8;
                ctx.moveTo(x + r, y);
                ctx.lineTo(x + w - r, y);
                ctx.quadraticCurveTo(x + w, y, x + w, y + r);
                ctx.lineTo(x + w, y + h - r);
                ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
                ctx.lineTo(x + r, y + h);
                ctx.quadraticCurveTo(x, y + h, x, y + h - r);
                ctx.lineTo(x, y + r);
                ctx.quadraticCurveTo(x, y, x + r, y);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();

                // Text (White for readability)
                ctx.shadowBlur = 0; 
                ctx.fillStyle = '#ffffff'; 
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(this.text, 0, 0);

                ctx.restore();
            }
        }

        class Car {
            constructor(isBroken) {
                this.width = 40; this.height = 65;
                this.x = Math.random() * (canvas.width - 50); this.y = -100;
                this.isBroken = isBroken;
                this.speed = isBroken ? 0.5 : (Math.random() * 2 + 3); 
                const colors = ['#3b82f6', '#10b981', '#8b5cf6', '#ec4899', '#ef4444', '#f97316'];
                this.color = isBroken ? '#64748b' : colors[Math.floor(Math.random() * colors.length)]; 
                this.repaired = false; this.blinkerState = false; this.blinkerTimer = 0;
            }
            update() {
                if (gameState === 'PLAYING') {
                    let moveSpeed = this.isBroken ? gameSpeed : (gameSpeed + this.speed * 0.5);
                    this.y += moveSpeed;
                }
                if (this.isBroken && !this.repaired) {
                    this.blinkerTimer++;
                    if (this.blinkerTimer > 8) { this.blinkerState = !this.blinkerState; this.blinkerTimer = 0; }
                    if (Math.random() > 0.6) particles.push(new Smoke(this.x + this.width/2, this.y + 10)); 
                }
            }
        }

        class Smoke {
            constructor(x, y) {
                this.x = x; this.y = y; this.size = Math.random() * 6 + 3;
                this.alpha = 0.6; this.vy = -1 - Math.random() * 1.5; this.vx = (Math.random() - 0.5) * 3;
            }
            update() { this.y += this.vy; this.x += this.vx; this.alpha -= 0.03; this.size += 0.15; }
            draw() {
                ctx.fillStyle = `rgba(148, 163, 184, ${this.alpha})`;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
            }
        }

        /* --- RENDER --- */

        function drawVehicle(x, y, w, h, color, type, blinkerOn) {
            ctx.save();
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(x + 8, y + 8, w, h);
            ctx.fillStyle = color; ctx.fillRect(x, y, w, h);

            if (type === 'towtruck') {
                ctx.fillStyle = '#e6b800'; ctx.fillRect(x, y, w, h * 0.35);
                ctx.fillStyle = '#1e293b'; ctx.fillRect(x + 4, y + h * 0.4, w - 8, h * 0.55);
                ctx.fillStyle = '#ffdb4d'; ctx.fillRect(x + 5, y + 5, w - 10, 4); 
                ctx.fillStyle = '#0f172a'; ctx.fillRect(x + 5, y + 10, w - 10, 10);

                if (gameState === 'REPAIRING') {
                    const time = Date.now() / 100;
                    const alpha = (Math.sin(time * 5) + 1) / 2 * 0.6 + 0.4;
                    const cx = x + w/2; const cy = y + 7;
                    const g = ctx.createRadialGradient(cx, cy, 5, cx, cy, 50);
                    g.addColorStop(0, `rgba(255, 205, 0, ${alpha})`);
                    g.addColorStop(1, 'transparent');
                    ctx.fillStyle = g; ctx.beginPath(); ctx.arc(cx, cy, 50, 0, Math.PI*2); ctx.fill();
                    ctx.shadowBlur=20; ctx.shadowColor='#ffcd00'; ctx.fillStyle='#ffe680'; 
                    ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
                }
                
                // SHIELD EFFECT
                if (shieldActive) {
                    const time = Date.now() / 200;
                    const pulse = (Math.sin(time) + 1) / 2 * 0.4 + 0.3; // 0.3 to 0.7
                    
                    ctx.strokeStyle = 'var(--shield-color)'; // Cyan
                    ctx.lineWidth = 3;
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = 'var(--shield-color)';
                    
                    ctx.globalAlpha = pulse;
                    ctx.beginPath();
                    ctx.arc(x + w/2, y + h/2, 60, 0, Math.PI*2);
                    ctx.stroke();
                    ctx.globalAlpha = 1.0;
                    ctx.shadowBlur = 0;
                }
                
                // MAGNET EFFECT
                if (magnetActive) {
                    const time = Date.now() / 150;
                    // Draw concentric arcs radiating outwards
                    ctx.strokeStyle = 'var(--magnet-color)'; 
                    ctx.lineWidth = 2;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = 'var(--magnet-color)';
                    
                    for(let i=0; i<3; i++) {
                         const offset = (time + i*10) % 40; // loops 0 to 40
                         const alpha = 1 - (offset / 40); // fades out
                         const radius = 40 + offset;
                         
                         ctx.globalAlpha = alpha;
                         ctx.beginPath();
                         // Draw arc above truck
                         ctx.arc(x + w/2, y + h/2, radius, Math.PI, 2*Math.PI); // Top half arc
                         ctx.stroke();
                    }
                    ctx.globalAlpha = 1.0;
                    ctx.shadowBlur = 0;
                }
                
            } else {
                ctx.fillStyle = '#0f172a'; ctx.fillRect(x+4, y+12, w-8, 10);
                ctx.fillRect(x+4, y+h-18, w-8, 8);
                ctx.fillStyle = color; ctx.globalAlpha=0.9; ctx.fillRect(x+6, y+20, w-12, h-35); ctx.globalAlpha=1.0;
                ctx.fillStyle = '#fef3c7'; ctx.fillRect(x+2, y+h-5, 8, 4); ctx.fillRect(x+w-10, y+h-5, 8, 4);
            }

            if (blinkerOn) {
                ctx.fillStyle = '#f97316'; ctx.shadowBlur = 15; ctx.shadowColor = '#ea580c';
                ctx.fillRect(x-4, y, 8, 8); ctx.fillRect(x+w-4, y, 8, 8);
                ctx.fillRect(x-4, y+h-8, 8, 8); ctx.fillRect(x+w-4, y+h-8, 8, 8);
                ctx.shadowBlur = 0;
            }
            ctx.restore();
        }

        /* --- CONTROL & LOOP --- */

        function spawnCar() {
            if (gameState !== 'PLAYING') return;
            cars.push(new Car(Math.random() < 0.35));
            
            // PROGRESSIVE DIFFICULTY
            const difficultyFactor = Math.min(0.5, repairsCount * 0.02); 
            const minTime = 700 * (1 - difficultyFactor);
            const variance = 900 * (1 - difficultyFactor);
            setTimeout(spawnCar, Math.random() * variance + minTime);
        }

        function handleInput(type, code) {
            // ADMIN INPUT
            if (adminOverlay.style.display === 'flex' && type === 'keydown') {
                if (code === 'Enter') adminLogin(); // Better UX on desktop
                if (code === 'Escape') closeAdmin();
                return;
            }

            // DIAGNOSTIC MODE CONTROLS
            if ((gameState === 'DIAGNOSING' || gameState === 'BOOTING') && type === 'keydown') {
                if (gameState === 'BOOTING') return; // Lock inputs during boot
                if (code === 'ArrowUp') {
                    diagSelectedIndex = Math.max(0, diagSelectedIndex - 1);
                    renderDiagOptions();
                } else if (code === 'ArrowDown') {
                    diagSelectedIndex = Math.min(3, diagSelectedIndex + 1);
                    renderDiagOptions();
                } else if (code === 'Enter' || code === 'Space') {
                    resolveDiagnostic();
                }
                return; // Stop other inputs
            }

            if (type === 'keydown') {
                if (gameState === 'GAMEOVER' && code === 'Space') {
                    if (document.activeElement.tagName === 'INPUT') return;
                    resetGame();
                }
                
                // Start with Space or Enter only if we are in Start Screen
                if (gameState === 'START' && (code === 'Space' || code === 'Enter')) {
                    startGame();
                }
                
                // Allow enter on name input
                if (nameEntryScreen.style.display === 'flex' && code === 'Enter') {
                    saveNameAndStart();
                }
                
                if (code === 'ArrowLeft' || code === 'KeyA') player.moveLeft = true;
                if (code === 'ArrowRight' || code === 'KeyD') player.moveRight = true;
            }
            if (type === 'keyup') {
                if (code === 'ArrowLeft' || code === 'KeyA') player.moveLeft = false;
                if (code === 'ArrowRight' || code === 'KeyD') player.moveRight = false;
            }
        }
        window.addEventListener('keydown', e => handleInput('keydown', e.code));
        window.addEventListener('keyup', e => handleInput('keyup', e.code));

        let touchX = null;
        container.addEventListener('touchstart', e => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
            
            touchX = e.touches[0].clientX;
            if(e.cancelable && gameState === 'PLAYING') e.preventDefault();
        });
        
        container.addEventListener('touchmove', e => {
            if(touchX !== null && gameState === 'PLAYING') {
                const diff = e.touches[0].clientX - touchX;
                player.x += diff * 1.5;
                if(player.x < 0) player.x = 0; if(player.x > canvas.width - player.width) player.x = canvas.width - player.width;
            }
            touchX = e.touches[0].clientX;
            if(e.cancelable && gameState === 'PLAYING') e.preventDefault();
        });

        function startGame() {
            gameState = 'PLAYING'; startScreen.style.display = 'none';
            player.x = canvas.width/2 - player.width/2; player.y = canvas.height - 130;
            cars = []; particles = []; floatingTexts = []; score = 0;
            repairsCount = 0;
            missedRepairs = 0;
            dodgedCars = 0;
            solvedAMDs = 0;
            gameSpeed = baseSpeed; 
            combo = 0; // Reset Combo
            shieldActive = false; // Reset shield
            magnetActive = false; // Reset magnet
            shieldEndTime = 0;
            powerupEndTime = 0;
            document.getElementById('powerupDisplay').style.display = 'none';
            scoreBoard.textContent = 0; scoreBoard.style.color = '#fff';
            comboText.style.display = 'none';
            spawnCar(); animate();
        }

        function resetGame() {
            gameOverScreen.style.display = 'none';
            diagnosticOverlay.style.display = 'none';
            fetchLeaderboard();
            startScreen.style.display = 'flex'; 
            gameState = 'START';
        }

        function startRepair(targetCar) {
            gameState = 'REPAIRING'; currentTarget = targetCar; repairTimer = 0;
            repairBar.style.display = 'block'; repairBar.style.left = (player.x - 8) + 'px'; repairBar.style.top = (player.y - 20) + 'px';
        }

        function finishRepair() {
            // COMBO SYSTEM
            combo++;
            // Calculate points: 10 base + combo bonus (e.g. +2 per combo step)
            const points = 10 + (combo * 2);
            score += points;
            repairsCount++;
            
            // Visual feedback
            let comboMsg = `+${points}`;
            if (combo > 1) {
                comboMsg += ` (Combo x${combo})`;
                comboText.style.display = 'block';
                comboText.textContent = `COMBO x${combo}`;
                // Optional: Make combo text pulse or grow
                comboText.style.transform = `scale(${1 + Math.min(0.5, combo * 0.1)})`;
            }
            
            repairBar.style.display = 'none';
            if(currentTarget) { 
                currentTarget.repaired = true; 
                currentTarget.isBroken = false; 
                currentTarget.color = '#10b981'; 
                currentTarget.speed = 6; 
            }
            currentTarget = null; 
            scoreBoard.textContent = score; 
            
            if (repairsCount % 5 === 0) {
                 gameSpeed = Math.min(12, baseSpeed + (repairsCount / 5) * 0.5);
                 floatingTexts.push(new FloatingSign(player.x, player.y - 80, "LEVEL UP! FASTER!", "#f59e0b"));
            }

            if (repairsCount > 0 && repairsCount % 20 === 0) {
                triggerDiagnosticMode();
            } else {
                gameState = 'PLAYING';
                floatingTexts.push(new FloatingSign(player.x, player.y - 40, comboMsg, "#10b981"));
                spawnCar();
            }
        }

        function crash(reason) {
            gameState = 'GAMEOVER'; finalScoreDisplay.textContent = score;
            const titleElement = document.getElementById('gameOverTitle');
            if (titleElement) titleElement.textContent = reason || "Unfall!";

            document.getElementById('statRepairs').textContent = repairsCount;
            document.getElementById('statMissed').textContent = missedRepairs;
            document.getElementById('statDodged').textContent = dodgedCars;
            document.getElementById('statAMDs').textContent = solvedAMDs;
            
            // Auto-Submit Score without prompt
            autoSubmitScore();

            gameOverScreen.style.display = 'flex'; repairBar.style.display = 'none';
            diagnosticOverlay.style.display = 'none';
        }

        function update() {
            particles.forEach((p, i) => { p.update(); if(p.alpha <= 0) particles.splice(i, 1); });
            floatingTexts.forEach((ft, i) => { ft.update(); if(ft.life <= 0) floatingTexts.splice(i, 1); });

            // POWERUP TIMER UPDATE
            if (shieldActive || magnetActive) {
                const remaining = Math.ceil((powerupEndTime - Date.now()) / 1000);
                if (remaining <= 0) {
                    shieldActive = false;
                    magnetActive = false;
                    document.getElementById('powerupDisplay').style.display = 'none';
                    floatingTexts.push(new FloatingSign(player.x, player.y - 60, "POWERUP ABGELAUFEN", "#ef4444"));
                } else {
                    document.getElementById('powerupTimer').innerText = remaining + "s";
                }
            }

            if (gameState === 'PLAYING') {
                roadOffset += gameSpeed; if (roadOffset > 40) roadOffset = 0;
                if (player.moveLeft && player.x > 0) player.x -= player.speed;
                if (player.moveRight && player.x < canvas.width - player.width) player.x += player.speed;

                cars.forEach((car, index) => {
                    car.update();
                    let padding = 6;
                    
                    // MAGNET LOGIC: Increase detection range for BROKEN cars
                    if (magnetActive && car.isBroken && !car.repaired) {
                        // Increase padding significantly to "pull" the car
                        // Standard width is ~40, lane is wide. Let's make it catch from ~50px away
                        padding = -60; // Negative padding makes hitbox huge
                    }

                    if (player.x + padding < car.x + car.width - padding && player.x + player.width - padding > car.x + padding && player.y + padding < car.y + car.height - padding && player.y + player.height - padding > car.y + padding) {
                        if (car.isBroken && !car.repaired) {
                             startRepair(car); 
                        } else if (!car.isBroken && !car.repaired) {
                             // CRASH LOGIC WITH SHIELD CHECK
                             if (!shieldActive) {
                                 crash("Unfall!");
                             } else {
                                 // Shield Active
                                 if (!car.hitByShield) { 
                                     floatingTexts.push(new FloatingSign(car.x + car.width/2, car.y, "ABGEWEHRT!", "#06b6d4"));
                                     car.hitByShield = true;
                                 }
                             }
                        }
                    }
                    if (car.y > canvas.height + 50) {
                        if (car.isBroken && !car.repaired) {
                            // Penalty logic
                            score -= 5; 
                            missedRepairs++;
                            scoreBoard.textContent = score;
                            floatingTexts.push(new FloatingSign(car.x + car.width/2 - 10, canvas.height - 40, "-5", "#ef4444"));
                            
                            // COMBO BREAKER
                            if (combo > 0) {
                                floatingTexts.push(new FloatingSign(player.x, player.y - 80, "C-C-C-Combo breaker!!!!", "#ef4444"));
                                combo = 0;
                                comboText.style.display = 'none';
                            }
                            
                            scoreBoard.style.color = '#ef4444';
                            if (score < 0) crash("Pannenquote!"); else setTimeout(() => { if(gameState === 'PLAYING') scoreBoard.style.color = '#fff'; }, 300);
                        } else if (!car.isBroken) {
                             dodgedCars++;
                        }
                        cars.splice(index, 1);
                    }
                });
            } else if (gameState === 'REPAIRING') {
                repairTimer++; let pct = (repairTimer / repairDuration) * 100; repairFill.style.width = pct + '%';
                repairBar.style.left = (player.x - 8) + 'px';
                if (repairTimer >= repairDuration) finishRepair();
            }
        }

        function draw() {
            ctx.fillStyle = '#1e293b'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#334155'; ctx.lineWidth = 4; ctx.setLineDash([30, 40]); ctx.lineDashOffset = -roadOffset; 
            ctx.beginPath(); ctx.moveTo(canvas.width / 2, -50); ctx.lineTo(canvas.width / 2, canvas.height + 50); ctx.stroke();
            ctx.setLineDash([]); ctx.lineWidth = 8; ctx.strokeStyle = '#475569';
            ctx.beginPath(); ctx.moveTo(10, 0); ctx.lineTo(10, canvas.height); ctx.moveTo(canvas.width - 10, 0); ctx.lineTo(canvas.width - 10, canvas.height); ctx.stroke();

            cars.forEach(car => drawVehicle(car.x, car.y, car.width, car.height, car.color, 'car', car.blinkerState));
            player.y = canvas.height - 130;
            drawVehicle(player.x, player.y, player.width, player.height, player.color, 'towtruck', false);
            particles.forEach(p => p.draw()); floatingTexts.forEach(ft => ft.draw());
        }

        function animate() {
            if (gameState !== 'GAMEOVER') { update(); draw(); requestAnimationFrame(animate); }
        }

        // Init
        resizeCanvas(); player.y = canvas.height - 130; player.x = canvas.width/2 - 22; draw();
        
        // Start Check
        initGame();

    </script>
</body>
</html>
